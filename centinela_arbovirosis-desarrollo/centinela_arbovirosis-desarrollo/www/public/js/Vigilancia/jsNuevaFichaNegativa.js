///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////// VARIABLES ///////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// FUNCIONES  //////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////// OPCIONES  ///////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////// APIS - llamdas al servidor ///////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


const registrarFicha = (datas) => {
	return new Promise((resolve, reject) => {

		fetch('registrarFichaNegativa', {
				method: 'POST',
				body: datas
			})
			.then(respuesta => respuesta.json())
			.then(datos => {
				resolve(datos);
			})
			.catch(msg => {
				reject(msg)
			})
	})
}


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// EVENTOS //////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

document.getElementById('_registrar_ficha').addEventListener('submit', e => {
	e.preventDefault()
	console.log('Entra')
	let btn = document.querySelector('.registrar_fichas')

	if (document.getElementById('fecha_notificacion').value == '') {
		Mensaje2(2, 'Campos obligatorios', 'Entendido', 'Se deben ingresar las fechas que se solicitan')
		return
	} 

	const data = new FormData()
		data.append('responsable_epidemiologia', document.getElementById('responsable_epidemiologia').value.toUpperCase())
		data.append('fecha_notificacion', document.getElementById('fecha_notificacion').value)
		data.append('observacion', document.getElementById('observacion').value.toUpperCase())


	if (!esFechaDeEsteAnio(document.getElementById('fecha_notificacion'))) {
		Swal.fire({
			title: "Revisar fechas",
			text: "Se están registrando fechas que no son de este año, ¿desea continuar con el registro?",
			icon: "info",
			showCancelButton: true,
			confirmButtonColor: "#adadad",
			cancelButtonColor: "#d33",
			confirmButtonText: "Cancelar",
			cancelButtonText: "Sí, continuar",
		}).then((result) => {
			if (result.dismiss == "cancel") {
				mostrarSpinner(btn)
				registrarFicha(data)
					.then(datos => {
						console.log(datos)
						if (!revisionDatos(datos)) {					
							return
						}
						ocultarSpinner(btn)
						Mensaje2(1, 'Ficha Negativa registrada', 'Entendido', 'La ficha negativa ha sido creada correctamente')
					})
					.then(dat => {
						debugger
						document.getElementById('_registrar_ficha').reset()
						$("#fecha_notificacion").flatpickr(calendarioNormal);
					})
				}
		});
	}else{
		mostrarSpinner(btn)
				registrarFicha(data)
					.then(datos => {
						console.log(datos)
						if (!revisionDatos(datos)) {					
							return
						}
						ocultarSpinner(btn)
						Mensaje2(1, 'Ficha Negativa registrada', 'Entendido', 'La ficha negativa ha sido creada correctamente')
					})
					.then(dat => {
						debugger
						document.getElementById('_registrar_ficha').reset()
						$("#fecha_notificacion").flatpickr(calendarioNormal);
					})
	}

		

		
	

})

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////// INICIALIZACIONES ///////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

$(document).ready(function () {
	// 	// ══════════════════════════════════════════ 
	// 	// VALOR QUE SE EJECUTA AL INICIAR - DEFECTO
	// 	// ════╦═════════════════════════════════════
	// 	//     ║
	// 	//     ╠═  Automatical started click
	// 	/*     ║  */
				$("#fecha_notificacion").flatpickr(calendarioNormal);
	// 	//     ║
	// 	//     ║
				autosize(document.querySelectorAll('textarea'));

	// 	//     ║
	// 	//     ║
	// 	//     ╚═  Tabla Citas
	// 	/*        */
	// 	$('#tbl_fichas').DataTable(params_tbl_edas_general);




	// 	// FUNCIONES A EJECUTAR COMO INICIALIZACIONES Y EN SIMULTANEO

	// 	Promise.all([
	// 			//     ║
	// 			//     ╠═ Listar las citas creadas
	// 			/*     ║   */	
	// 			listarFichasdeVigilancia(),
	// 			//     ║
	// 			//     ╚═ Fecha actual con hora 7am
	// 			/*         */
	// 			// iniciarFechaHora()
	// 		])
	// 		.then(data => {

	// 			if (!revisionDatos(data[0])) {
	// 				return
	// 			}
	// 			let misFichas = data[0].data
	// 			console.log(misFichas)
	// 			limpiarTabla('tbl_fichas')
	// 			agregarDataTabla('tbl_fichas',misFichas)


	// 		})
	// 		.catch(error => {
	// 			Mensaje2(0,'Error de sistema','Ok','Hubo un error en el sistema')
	// 		});

})


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////// UTILITIES //////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

